<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"> <!-- begin SEO --><title>Automatically mirror a github repository with CircleCI - Predictably Noisy</title><meta property="og:locale" content="en-US"><meta property="og:site_name" content="Predictably Noisy"><meta property="og:title" content="Automatically mirror a github repository with CircleCI"><link rel="canonical" href="https://predictablynoisy.com/circleci-mirror"><meta property="og:url" content="https://predictablynoisy.com/circleci-mirror"><meta name="twitter:site" content="@choldgraf"><meta name="twitter:title" content="Automatically mirror a github repository with CircleCI"><meta name="twitter:description" content="About Me"><meta name="twitter:url" content="https://predictablynoisy.com/circleci-mirror"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://predictablynoisy.com/images/profile.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-12-18T00:00:00+00:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Organization", "url": "https://predictablynoisy.com", "logo": "https://predictablynoisy.com/images/profile.png" } </script> <script type="application/ld+json"> { "@context" : "https://schema.org", "@type" : "Person", "name" : "Chris Holdgraf", "url" : "https://predictablynoisy.com", "sameAs" : null } </script> <!-- end SEO --><link href="https://predictablynoisy.com/feed.xml" type="application/atom+xml" rel="alternate" title="Predictably Noisy Feed"> <!-- http://t.co/dKP3o1e --><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Jupyter Book CSS and JS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Custom CSS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/jupyterbook.css"> <script type="text/javascript" src="https://predictablynoisy.com/assets/js/jupyterbook.js"></script><meta http-equiv="cleartype" content="on"> <!-- start custom head snippets --><link rel="apple-touch-icon" sizes="57x57" href="https://predictablynoisy.com/images/apple-touch-icon-57x57.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="60x60" href="https://predictablynoisy.com/images/apple-touch-icon-60x60.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="72x72" href="https://predictablynoisy.com/images/apple-touch-icon-72x72.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="76x76" href="https://predictablynoisy.com/images/apple-touch-icon-76x76.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="114x114" href="https://predictablynoisy.com/images/apple-touch-icon-114x114.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="120x120" href="https://predictablynoisy.com/images/apple-touch-icon-120x120.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="144x144" href="https://predictablynoisy.com/images/apple-touch-icon-144x144.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="152x152" href="https://predictablynoisy.com/images/apple-touch-icon-152x152.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="180x180" href="https://predictablynoisy.com/images/apple-touch-icon-180x180.png?v=M44lzPylqQ"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16"><link rel="manifest" href="https://predictablynoisy.com/images/manifest.json?v=M44lzPylqQ"><link rel="mask-icon" href="https://predictablynoisy.com/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000"><link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ"><meta name="msapplication-TileColor" content="#000000"><meta name="msapplication-TileImage" content="https://predictablynoisy.com/images/mstile-144x144.png?v=M44lzPylqQ"><meta name="msapplication-config" content="https://predictablynoisy.com/images/browserconfig.xml?v=M44lzPylqQ"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/academicons.css"/> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> <!-- Load JQuery --> <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> <!-- Load clipboard.js --> <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script> <!-- Custom scripts to load after site JS is loaded --> <script src="https://predictablynoisy.com/assets/js/copypaste.js" type="text/javascript"></script> <!-- end custom head snippets --><link rel="stylesheet" href="/assets/css/data8.css"><link rel="stylesheet" href="/assets/css/holdgraf.css"></head><body> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <button><div class="navicon"></div></button><ul class="visible-links"><li class="masthead__menu-item masthead__menu-item--lg"><a href="https://predictablynoisy.com/">Predictably Noisy</a></li><li class="masthead__menu-item"><a href="/about/">About me</a></li><li class="masthead__menu-item"><a href="/publications/">Publications</a></li></ul><ul class="hidden-links hidden"></ul></nav></div></div></div><div id="main" role="main"><div class="sidebar sticky"><div itemscope itemtype="http://schema.org/Person"><div class="author__avatar"> <img src="https://predictablynoisy.com/images/profile.png" class="author__avatar" alt="Chris Holdgraf"></div><div class="author__content"><h3 class="author__name">Chris Holdgraf</h3><p class="author__bio">Data Science | Open Science | Brains</p></div><div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button><ul class="author__urls social-icons"><li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Berkeley, CA</li><li><a href="mailto:hldgrf@gmail.com"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="https://www.linkedin.com/in/chrisholdgraf"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li><li><a href="https://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li><li><a href="https://scholar.google.com/citations?user=fJmcIEIAAAAJ&hl=en"><i class="ai ai-google-scholar-square ai-fw"></i> Google Scholar</a></li><li><a href="https://orcid.org/0000-0002-2391-0678"><i class="ai ai-orcid-square ai-fw"></i> ORCID</a></li></ul></div></div></div><article class="page" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="headline" content="Automatically mirror a github repository with CircleCI"><meta itemprop="datePublished" content="December 18, 2018"><div class="page__inner-wrap"><header><h1 class="page__title" itemprop="headline">Automatically mirror a github repository with CircleCI</h1><p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Published:</strong> <time datetime="2018-12-18T00:00:00+00:00">December 18, 2018</time></p></header><section class="page__content" itemprop="text"><blockquote><p>tl;dr: you can automatically mirror the contents of one repository to another by using CI/CD services like CircleCI. This post shows you one way to do it using secrets that let you push to a GitHub repository from a CircleCI process.</p></blockquote><p>We recently ran into an issue with the Data 8 course where we needed to mirror one GitHub site to another. In short, the textbook is built with a tool called <a href="https://predictablynoisy.com/jupyter-book/intro.html">jupyter-book</a>, and we use <a href="https://pages.github.com/">github-pages</a> to host the content at <a href="https://inferentialthinking.com">inferentialthinking.com</a>. For <a href="https://help.github.com/articles/custom-domain-redirects-for-github-pages-sites/">weird URL-naming reasons</a>, we had to create <a href="https://github.com/inferentialthinking/inferentialthinking.github.io">a second organization</a> to host the actual site. This introduced the complexity that any time the textbook had to be updated, we did so in <em>two</em> different places. The raw textbook content is hosted at https://github.com/data-8/textbook, and the version hosted online is at https://github.com/inferentialthinking/inferentialthinking.github.io.</p><p>This is a pain, because now a person has to take several actions across two repositories any time we update the textbook content. But not anymore! Now we use CirleCI to automatically deploy an update to inferentialthinking.com any time a change is made to data-8/textbook. Here are the steps to do it.</p><p>In these steps, we’ll have two repositories, one with the “primary” repository we want to keep, and one with the “mirror” repository that should always contain exactly the content of the “primary” repo. I’ll call these “primary” and “mirror” repos from here on out (no, I won’t call them master and slave but that’s a whole other conversation).</p><h2 id="what-we-want-to-do">What we want to do</h2><p>Ultimately, we’d like the following thing to happen:</p><blockquote><p><strong>Whenever a change is pushed to the “primary” repository, CircleCI should push those changes to the “mirror” repository.</strong></p></blockquote><p>Since CircleCI already lets you run semi-arbitrary code, this is relatively straightforward, with one big caveat: permissions. GitHub doesn’t let <em>anybody</em> push to <em>any</em> repository, so we need some way to allow CircleCI to push to our mirror repository. That’s what these steps are all about.</p><h2 id="step-1-create-an-ssh-key-for-your-mirror-github-repository">Step 1: Create an SSH key for your mirror github repository</h2><p>First off, we need to tell the mirror repository “you should let anyone with these credentials push to the repo”. We’ll do this by creating a “deploy key”. This is a SSH public/private key pair that, when combined, will allow anybody to push to your repository. <strong>If anybody has the private key, they have push access to your repo</strong>, so keep the private key safe!</p><p>First, create a new public/private key pair with this command (in a *nix system):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -f ~/key.txt
</code></pre></div></div><p><strong>when it asks for a passphrase, simply hit enter twice</strong>. This makes the passphrase empty.</p><p>This generates two files in your home directory:</p><ul><li><code class="language-plaintext highlighter-rouge">key.txt</code> is your private key. You <strong>should not share this w/ others</strong> unless you know what you’re doing.</li><li><code class="language-plaintext highlighter-rouge">key.txt.pub</code> is your public key. You can share this w/ others.</li></ul><h2 id="step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo">Step 2: Add this SSH key as a “deploy key” to your mirror repo</h2><p>In your github repository, go to <code class="language-plaintext highlighter-rouge">settings -&gt; deploy keys -&gt; add deploy key</code>. See the diagram below for the steps:</p><p><img src="/images/2018/circleci-mirror-deploy-key-ui.png" alt="" /></p><p>When you click <code class="language-plaintext highlighter-rouge">add deploy key</code>, it’ll open an interface for you to add the <em>public</em> key for the deployment permissions. Copy the text of your <strong>public key</strong> (at <code class="language-plaintext highlighter-rouge">~/key.txt.pub</code>) and paste it in the window like so:</p><p><img src="/images/2018/circleci-deploy-key-ssh.png" alt="" /></p><p>Remember, this is the <strong>public</strong> key for your repository. This means that anyone with the <strong>private</strong> key will now be able to push to the repo.</p><h2 id="step-3-set-up-circleci-for-your-primary-repository">Step 3: Set up CircleCI for your “primary” repository</h2><p>Next, we need to set up CircleCI to build our primary repository with continuous integration. I recommend following the <a href="https://circleci.com/docs/2.0/getting-started/">CircleCI getting started guide</a>. Once you follow this, CircleCI will automatically generate new builds for your repository following the configuration you specify in <code class="language-plaintext highlighter-rouge">.circleci/config.yml</code>.</p><p>Here’s a good start for a config.yml file:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="na">only</span><span class="pi">:</span>
        <span class="c1"># Tell Circle only to build this branch</span>
        <span class="pi">-</span> <span class="s">gh-pages</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="c1"># Any Docker image should do, since we only need git</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/python:3.6-stretch</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># This ensures that the working directory contains the contents of your repo</span>
      <span class="pi">-</span> <span class="s">checkout</span>
      <span class="c1"># We'll add more steps here</span>
</code></pre></div></div><p>Next, we’ll configure that yaml file to do what we want.</p><h2 id="step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository">Step 4: Configure CircleCI to push the primary repository to the mirror repository</h2><p>Now that CircleCI is building the primary repo, it’s time to tell it to do what we want. We’ll modify the workflow in the <code class="language-plaintext highlighter-rouge">.circleci/config.yml</code> file to do the following:</p><ol><li>add the mirror repository as a git remote</li><li>push the latest copy of <code class="language-plaintext highlighter-rouge">master</code> from the primary repository to the mirror repository (the latest version of the primary repository is already in the CircleCI build because of the <code class="language-plaintext highlighter-rouge">- checkout</code> command).</li></ol><p>Here’s the piece of configuration to do do this:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Push to the inferentialthinking.github.io repository so it goes live</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Updating inferentialthinking website</span>
          <span class="na">command</span><span class="pi">:</span> <span class="s">git push live_textbook gh-pages:master</span>
</code></pre></div></div><p>Now we’re telling CircleCI to push to our mirror repository, but you’ll notice that it won’t be able to complete this action. This is because CircleCI doesn’t currently have the <strong>permissions</strong> needed to push to the mirror repository. Time to use that public/private key from before!</p><h2 id="step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings">Step 5: Add your private key to the primary repository Circle CI settings</h2><p>Next, we need to give CircleCI the ability to push to our mirror repository by using the public/private key that we generated earlier. Remember that anybody with the <strong>private</strong> key can push to your mirror repository. We can add the private key in a secure fashion to our CircleCI builds using their interface. Go to the <em>settings</em> page for your repository within CircleCI, then <code class="language-plaintext highlighter-rouge">SSH Permissions -&gt; Add SSH Key</code>.</p><p><img src="/images/2018/circleci-add-ssh-ui.png" alt="" /></p><p>This brings up a dialog where you can add your <strong>private</strong> key. This is the text inside <code class="language-plaintext highlighter-rouge">~/key.txt</code>. Copy that text and paste it in the <code class="language-plaintext highlighter-rouge">Private Key</code> box.</p><p>In the <code class="language-plaintext highlighter-rouge">Hostname</code> box, put <code class="language-plaintext highlighter-rouge">github.com</code>.</p><p><img src="/images/2018/circleci-private-key-entry.png" alt="" /></p><p>Now that CircleCI has our private key, we need to configure it to use this key during builds.</p><p><strong>I’d recommend now deleting the <code class="language-plaintext highlighter-rouge">key.txt</code> and <code class="language-plaintext highlighter-rouge">key.txt.pub</code> files from your computer, just to make sure they don’t accidentally fall in the wrong hands</strong>. You can always generate a new public/private pair and follow the steps above if you need to update the CircleCI deploy keys.</p><h2 id="step-6-modify-your-circleci-configuration-to-use-your-private-key">Step 6: Modify your CircleCI configuration to use your private key</h2><p>Finally, we need to modify the yaml configuration so that it knows to use this public/private key combination when it does SSH stuff in the build. That’s accomplished with the following configuration:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Add deployment key fingerprint for CircleCI to use for a push</span>
      <span class="pi">-</span> <span class="na">add_ssh_keys</span><span class="pi">:</span>
          <span class="na">fingerprints</span><span class="pi">:</span>
            <span class="c1"># The SSH key fingerprint</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX"</span>
</code></pre></div></div><p>The SSH key fingerprint can be found by looking at your GitHub repository’s “Deploy Keys” page. It’ll contain a SHA that is unique and refers to the key you want. Copy and paste it using the configuration structure above. Here’s what one key looks like:</p><p><img src="/images/2018/circleci-fingerprint.png" alt="" /></p><h2 id="our-final-configuration">Our final configuration</h2><p>That should be all we need to allow CircleCI to push the contents from the primary repository to the mirror repository. Every time a change is made to the <code class="language-plaintext highlighter-rouge">master</code> branch of the primary repository, this process will be triggered.</p><p>This is what our final yaml configuration looks like:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="c1"># Only build for changes to the gh-pages branch</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="na">only</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">gh-pages</span>
    <span class="c1"># The base environment we'll use (can be any docker image w/ git)</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/python:3.6-stretch</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Move the repository code to our home directory in the CircleCI build</span>
      <span class="pi">-</span> <span class="s">checkout</span>
      <span class="c1"># Add deployment key fingerprint for CircleCI to use for a push</span>
      <span class="pi">-</span> <span class="na">add_ssh_keys</span><span class="pi">:</span>
          <span class="na">fingerprints</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX"</span>

      <span class="c1"># Add the mirror repository as a git remote</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git</span>
      <span class="c1"># Push the repository to the mirror site</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Updating inferentialthinking website</span>
          <span class="na">command</span><span class="pi">:</span> <span class="s">git push live_textbook gh-pages:master</span>
</code></pre></div></div></section><footer class="page__meta"></footer></div></article></div></script><div class="page__footer"><footer> <!-- start custom footer snippets --> <a href="/sitemap/">Sitemap</a> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons"><li><strong>Follow:</strong></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="http://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li><li><a href="https://predictablynoisy.com/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li></ul></div><div class="page__footer-copyright">&copy; 2020 Chris Holdgraf. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="https://predictablynoisy.com/assets/js/main.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-88310237-1', 'auto'); ga('send', 'pageview'); </script></body></html>
