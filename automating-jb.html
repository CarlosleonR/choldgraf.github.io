<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"> <!-- begin SEO --><title>Automating Jupyter Book deployments with CI/CD - Predictably Noisy</title><meta property="og:locale" content="en-US"><meta property="og:site_name" content="Predictably Noisy"><meta property="og:title" content="Automating Jupyter Book deployments with CI/CD"><link rel="canonical" href="https://predictablynoisy.com/automating-jb"><meta property="og:url" content="https://predictablynoisy.com/automating-jb"><meta name="twitter:site" content="@choldgraf"><meta name="twitter:title" content="Automating Jupyter Book deployments with CI/CD"><meta name="twitter:description" content="About Me"><meta name="twitter:url" content="https://predictablynoisy.com/automating-jb"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://predictablynoisy.com/images/profile.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2019-10-11T00:00:00+00:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Organization", "url": "https://predictablynoisy.com", "logo": "https://predictablynoisy.com/images/profile.png" } </script> <script type="application/ld+json"> { "@context" : "https://schema.org", "@type" : "Person", "name" : "Chris Holdgraf", "url" : "https://predictablynoisy.com", "sameAs" : null } </script> <!-- end SEO --><link href="https://predictablynoisy.com/feed.xml" type="application/atom+xml" rel="alternate" title="Predictably Noisy Feed"> <!-- http://t.co/dKP3o1e --><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Jupyter Book CSS and JS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Custom CSS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/jupyterbook.css"> <script type="text/javascript" src="https://predictablynoisy.com/assets/js/jupyterbook.js"></script><meta http-equiv="cleartype" content="on"> <!-- start custom head snippets --><link rel="apple-touch-icon" sizes="57x57" href="https://predictablynoisy.com/images/apple-touch-icon-57x57.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="60x60" href="https://predictablynoisy.com/images/apple-touch-icon-60x60.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="72x72" href="https://predictablynoisy.com/images/apple-touch-icon-72x72.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="76x76" href="https://predictablynoisy.com/images/apple-touch-icon-76x76.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="114x114" href="https://predictablynoisy.com/images/apple-touch-icon-114x114.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="120x120" href="https://predictablynoisy.com/images/apple-touch-icon-120x120.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="144x144" href="https://predictablynoisy.com/images/apple-touch-icon-144x144.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="152x152" href="https://predictablynoisy.com/images/apple-touch-icon-152x152.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="180x180" href="https://predictablynoisy.com/images/apple-touch-icon-180x180.png?v=M44lzPylqQ"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16"><link rel="manifest" href="https://predictablynoisy.com/images/manifest.json?v=M44lzPylqQ"><link rel="mask-icon" href="https://predictablynoisy.com/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000"><link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ"><meta name="msapplication-TileColor" content="#000000"><meta name="msapplication-TileImage" content="https://predictablynoisy.com/images/mstile-144x144.png?v=M44lzPylqQ"><meta name="msapplication-config" content="https://predictablynoisy.com/images/browserconfig.xml?v=M44lzPylqQ"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/academicons.css"/> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> <!-- Load JQuery --> <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> <!-- Load clipboard.js --> <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script> <!-- Custom scripts to load after site JS is loaded --> <script src="https://predictablynoisy.com/assets/js/copypaste.js" type="text/javascript"></script> <!-- end custom head snippets --><link rel="stylesheet" href="/assets/css/data8.css"><link rel="stylesheet" href="/assets/css/holdgraf.css"></head><body> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <button><div class="navicon"></div></button><ul class="visible-links"><li class="masthead__menu-item masthead__menu-item--lg"><a href="https://predictablynoisy.com/">Predictably Noisy</a></li><li class="masthead__menu-item"><a href="/about/">About me</a></li><li class="masthead__menu-item"><a href="/publications/">Publications</a></li></ul><ul class="hidden-links hidden"></ul></nav></div></div></div><div id="main" role="main"><div class="sidebar sticky"><div itemscope itemtype="http://schema.org/Person"><div class="author__avatar"> <img src="https://predictablynoisy.com/images/profile.png" class="author__avatar" alt="Chris Holdgraf"></div><div class="author__content"><h3 class="author__name">Chris Holdgraf</h3><p class="author__bio">Data Science | Open Science | Brains</p></div><div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button><ul class="author__urls social-icons"><li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Berkeley, CA</li><li><a href="mailto:hldgrf@gmail.com"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="https://www.linkedin.com/in/chrisholdgraf"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li><li><a href="https://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li><li><a href="https://scholar.google.com/citations?user=fJmcIEIAAAAJ&hl=en"><i class="ai ai-google-scholar-square ai-fw"></i> Google Scholar</a></li><li><a href="https://orcid.org/0000-0002-2391-0678"><i class="ai ai-orcid-square ai-fw"></i> ORCID</a></li></ul></div></div></div><article class="page" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="headline" content="Automating Jupyter Book deployments with CI/CD"><meta itemprop="datePublished" content="October 11, 2019"><div class="page__inner-wrap"><header><h1 class="page__title" itemprop="headline">Automating Jupyter Book deployments with CI/CD</h1><p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Published:</strong> <time datetime="2019-10-11T00:00:00+00:00">October 11, 2019</time></p></header><section class="page__content" itemprop="text"><p>Lately I’ve spent a lot of time trying to reduce the friction involved in deploying Jupyter Book as well as contributing to the project. Features are a great carrot, but ultimately getting engagement is also about lowering barriers to entry and showing people a path forward. Jupyter Book is a relatively straightforward project, but it involves a few technical pieces that can be painful to use (thanks Jekyll).</p><p>Recently I experimented with whether we can <strong>automate deploying a Jupyter Book online</strong>. Using continuous integration / deployment services seems like a natural place to try this out. One can upload a barebones set of code to a GitHub repository, then configure a build system to create a book and deploy it online from there. This blog post is a place to keep track of the current state of affairs for this workflow.</p><p><img src="/images/2019/jb-auto-build.png" alt="auto build logos" /></p><p><strong>I’ll publish the latest configuration files for this at <a href="https://github.com/choldgraf/jupyter-book-deploy-demo/">this repository</a></strong>.</p><h2 id="the-general-set-of-steps-involved">The general set of steps involved</h2><p>We’ll start with the simplest possible Jupyter Book configuration: to have a single folder with a collection of content inside. The folder looks like this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── content
│   ├── 01
|   │   ├──── notebook1.ipynb
│   │   └──── notebook2.ipynb
│   ├── 02
|   │   ├──── notebook3.ipynb
│   │   └──── mdfile4.md
...
|
└── configuration_files_for_cicd/
</code></pre></div></div><p>There’s no table of contents, and no configuration file (though we could add these if we wish). If Jupyter Book is used to create a new book with some content, but no TOC is given, it’ll automatically generate one.</p><p>Our goal is to do the following in an automated fashion:</p><ol><li>Build a new Jupyter Book template from this content folder (with <code class="language-plaintext highlighter-rouge">jupyter-book create</code>)</li><li>Build page HTML for the book (with <code class="language-plaintext highlighter-rouge">jupyter-book build</code>)</li><li>Generate the book’s site with Jekyll (with <code class="language-plaintext highlighter-rouge">bundle exec jekyll build</code>)</li><li>Host the results somewhere online</li></ol><p>Below are attempts to do this with CI/CD. I’ll update this post as new options become available (and hopefully push some stuff to the Jupyter Book documentation).</p><h2 id="netlify">Netlify</h2><p>By far the easiest way to accomplish the above is with the online website provider <a href="https://www.netlify.com">Netlify</a>. This was my first experience with the Netlify service, and I must say that I was really pleased (thanks to <a href="https://github.com/emdupre">Elizabeth DuPre</a> for the recommendation and <a href="https://jupyterbook.org/guide/publish/netlify.html">Netlify tutorial</a>).</p><p>Netlify has automatic deployment built into its service, since that’s the whole point of the site - to deploy websites from online repositories. To do this, I simply had to connect Netlify to my <a href="https://github.com/choldgraf/jupyter-book-deploy-demo/">book content repository</a> and tell it to start building a site from that repository’s contents.</p><p>I modified the build instructions using a custom “build” command. Netlify runs this command every time it tries to build your site. You can configure this by creating a <code class="language-plaintext highlighter-rouge">netlify.toml</code> file and putting it in the root of your repository. <a href="https://github.com/choldgraf/jupyter-book-deploy-demo/blob/master/netlify.toml">Here’s a link to my configuration file</a>.</p><p>The full text of that TOML file looks like this:</p><div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[build]</span>
  <span class="py">command</span> <span class="p">=</span> <span class="s">"""
    gem install bundler -v '2.0.2'
    pip install -U git+https://github.com/jupyter/jupyter-book
    jupyter-book create mybook --content-folder content
    cd mybook
    jupyter-book build ./ --overwrite
    make install
    bundle exec jekyll build
    """</span>

  <span class="py">publish</span> <span class="p">=</span> <span class="s">"mybook/_site"</span>
</code></pre></div></div><p>There are two pieces to this: the <code class="language-plaintext highlighter-rouge">command</code> section is the command to run first, when a new commit is pushed to a branch. The <code class="language-plaintext highlighter-rouge">publish</code> section defines the location where Netlify will look for the finished HTML (AKA, my book website).</p><p>Note that in the <code class="language-plaintext highlighter-rouge">jupyter-book create</code> command above, I used <code class="language-plaintext highlighter-rouge">--content-folder</code> to tell Jupyter Book to use some pre-existing content when it generated my book template. In addition, note that I could immediately install both Python and Ruby packages - that’s because Netlify’s base build environment has both languages installed already!</p><!-- #region {"tags": ["popout"]} --><p>One gotcha on getting Netlify to work was configuring it to use a Python 3.X environment. That’s accomplished with the <code class="language-plaintext highlighter-rouge">runtime.txt</code> file <a href="https://github.com/choldgraf/jupyter-book-deploy-demo/blob/master/runtime.txt">at this location</a>. <!-- #endregion --></p><p>By adding this configuration to my site, Netlify immediately started building and hosting the book. You can find <a href="https://jupyter-book-deploy-demo.netlify.com">that book deployment here</a>.</p><h2 id="circleci">CircleCI</h2><p><a href="https://circleci.com">CircleCI</a> is a website most-commonly used for running test suites and deploying things into production once those tests pass. Fortunately, deploying an HTML book is pretty similar!</p><p>Getting Jupyter Book to build on CircleCI was a little bit trickier for two reasons:</p><ol><li>CircleCI has more specific environments in its build system. You can have a Python environment, or a Ruby environment, but not both.</li><li>CircleCI has no concept of natively “hosting” HTML content, so we had to piggy-back on top of GitHub pages.</li></ol><p>Luckily, working around both of these issues was relatively straightforward. You can find the CircleCI configuration that ended up working <a href="https://github.com/choldgraf/jupyter-book-deploy-demo/blob/master/.circleci/config.yml">in the github repository</a>.</p><p>There were two gotchas in there:</p><ol><li>I started off with using a Ruby environment rather than a Python environment. That’s becuase I’ve found Python to be much easier to install than Ruby. In fact, installing python was as easy as including <code class="language-plaintext highlighter-rouge">sudo apt-get install python3-pip</code> in my commands.</li><li>I had to use a GitHub SSH deploy key to be able to deploy my built HTML to GitHub pages. You can find <a href="https://predictablynoisy.com/circleci-mirror">instructions for how to do so in this post</a>.</li></ol><p>Once that was accomplished, this is the configuration that got the job done:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2.1</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build_book</span><span class="pi">:</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/ruby:2.6</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">checkout</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Install Python and dependencies to build page HTML</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">sudo apt-get install python3-pip</span>
            <span class="s">pip3 install --user -r requirements.txt</span>
            <span class="s">pip3 install --user -U git+https://github.com/jupyter/jupyter-book.git</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Create book template and build page HTML</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">jupyter-book create mybook --content-folder content/</span>
            <span class="s">jupyter-book build ./mybook</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Install ruby dependencies and build the book's website</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">cd mybook</span>
            <span class="s">make install</span>
            <span class="s">bundle exec jekyll build</span>

      <span class="c1"># If we're on master, push to a gh-pages branch</span>
      <span class="pi">-</span> <span class="na">add_ssh_keys</span><span class="pi">:</span>
          <span class="na">fingerprints</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">&lt;my-public-fingerprint&gt;"</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Push to gh-pages (if on master)</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if [ $CIRCLE_BRANCH	== "master" ]; then</span>
              <span class="s">pip3 install ghp-import</span>
              <span class="s">ghp-import -n -f -p mybook/_site;</span>
            <span class="s">else</span>
              <span class="s">echo "Skipping deploy because we aren't on master"</span>
            <span class="s">fi</span>


<span class="na">workflows</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">build_book</span>
</code></pre></div></div><p>You can find the deployed site <a href="https://github.com/choldgraf/jupyter-book-deploy-demo">at this location</a>.</p><h2 id="wrapping-up">Wrapping up</h2><p>Ultimately, it was simpler than I expected to deploy a Jupyter Book with CI/CD. There are lots of other services to explore (in particular, TravisCI and GitHub actions), but I find it hard to believe anything would be more straightforward than Netlify.</p><p>That said, the process also made it clear that some pieces of the Jupyter Book API are a bit confusing. It felt natural to have my content in a single folder, and to build a book from that content, but this isn’t the “default” way that the documentation recommends. I’ll let these ideas simmer a little bit and we’ll see what comes out of it.</p></section><footer class="page__meta"><p class="page__taxonomy"> <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="https://predictablynoisy.com/tags/#infrastructure" class="page__taxonomy-item" rel="tag">infrastructure</a> </span></p></footer></div></article></div></script><div class="page__footer"><footer> <!-- start custom footer snippets --> <a href="/sitemap/">Sitemap</a> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons"><li><strong>Follow:</strong></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="http://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li><li><a href="https://predictablynoisy.com/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li></ul></div><div class="page__footer-copyright">&copy; 2020 Chris Holdgraf. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="https://predictablynoisy.com/assets/js/main.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-88310237-1', 'auto'); ga('send', 'pageview'); </script></body></html>
