<!doctype html><html lang="en" class="no-js"><head><meta charset="utf-8"> <!-- begin SEO --><title>Three things I love about CircleCI - Predictably Noisy</title><meta property="og:locale" content="en-US"><meta property="og:site_name" content="Predictably Noisy"><meta property="og:title" content="Three things I love about CircleCI"><link rel="canonical" href="https://predictablynoisy.com/three-things-circleci"><meta property="og:url" content="https://predictablynoisy.com/three-things-circleci"><meta name="twitter:site" content="@choldgraf"><meta name="twitter:title" content="Three things I love about CircleCI"><meta name="twitter:description" content="About Me"><meta name="twitter:url" content="https://predictablynoisy.com/three-things-circleci"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://predictablynoisy.com/images/profile.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2019-01-29T00:00:00+00:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Organization", "url": "https://predictablynoisy.com", "logo": "https://predictablynoisy.com/images/profile.png" } </script> <script type="application/ld+json"> { "@context" : "https://schema.org", "@type" : "Person", "name" : "Chris Holdgraf", "url" : "https://predictablynoisy.com", "sameAs" : null } </script> <!-- end SEO --><link href="https://predictablynoisy.com/feed.xml" type="application/atom+xml" rel="alternate" title="Predictably Noisy Feed"> <!-- http://t.co/dKP3o1e --><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Jupyter Book CSS and JS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/main.css"> <!-- Custom CSS --><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/jupyterbook.css"> <script type="text/javascript" src="https://predictablynoisy.com/assets/js/jupyterbook.js"></script><meta http-equiv="cleartype" content="on"> <!-- start custom head snippets --><link rel="apple-touch-icon" sizes="57x57" href="https://predictablynoisy.com/images/apple-touch-icon-57x57.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="60x60" href="https://predictablynoisy.com/images/apple-touch-icon-60x60.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="72x72" href="https://predictablynoisy.com/images/apple-touch-icon-72x72.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="76x76" href="https://predictablynoisy.com/images/apple-touch-icon-76x76.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="114x114" href="https://predictablynoisy.com/images/apple-touch-icon-114x114.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="120x120" href="https://predictablynoisy.com/images/apple-touch-icon-120x120.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="144x144" href="https://predictablynoisy.com/images/apple-touch-icon-144x144.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="152x152" href="https://predictablynoisy.com/images/apple-touch-icon-152x152.png?v=M44lzPylqQ"><link rel="apple-touch-icon" sizes="180x180" href="https://predictablynoisy.com/images/apple-touch-icon-180x180.png?v=M44lzPylqQ"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96"><link rel="icon" type="image/png" href="https://predictablynoisy.com/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16"><link rel="manifest" href="https://predictablynoisy.com/images/manifest.json?v=M44lzPylqQ"><link rel="mask-icon" href="https://predictablynoisy.com/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000"><link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ"><meta name="msapplication-TileColor" content="#000000"><meta name="msapplication-TileImage" content="https://predictablynoisy.com/images/mstile-144x144.png?v=M44lzPylqQ"><meta name="msapplication-config" content="https://predictablynoisy.com/images/browserconfig.xml?v=M44lzPylqQ"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://predictablynoisy.com/assets/css/academicons.css"/> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> <!-- Load JQuery --> <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script> <!-- Load clipboard.js --> <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script> <!-- Custom scripts to load after site JS is loaded --> <script src="https://predictablynoisy.com/assets/js/copypaste.js" type="text/javascript"></script> <!-- end custom head snippets --><link rel="stylesheet" href="/assets/css/data8.css"><link rel="stylesheet" href="/assets/css/holdgraf.css"></head><body> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <button><div class="navicon"></div></button><ul class="visible-links"><li class="masthead__menu-item masthead__menu-item--lg"><a href="https://predictablynoisy.com/">Predictably Noisy</a></li><li class="masthead__menu-item"><a href="/about/">About me</a></li><li class="masthead__menu-item"><a href="/publications/">Publications</a></li></ul><ul class="hidden-links hidden"></ul></nav></div></div></div><div id="main" role="main"><div class="sidebar sticky"><div itemscope itemtype="http://schema.org/Person"><div class="author__avatar"> <img src="https://predictablynoisy.com/images/profile.png" class="author__avatar" alt="Chris Holdgraf"></div><div class="author__content"><h3 class="author__name">Chris Holdgraf</h3><p class="author__bio">Data Science | Open Science | Brains</p></div><div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button><ul class="author__urls social-icons"><li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Berkeley, CA</li><li><a href="mailto:hldgrf@gmail.com"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="https://www.linkedin.com/in/chrisholdgraf"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li><li><a href="https://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li><li><a href="https://scholar.google.com/citations?user=fJmcIEIAAAAJ&hl=en"><i class="ai ai-google-scholar-square ai-fw"></i> Google Scholar</a></li><li><a href="https://orcid.org/0000-0002-2391-0678"><i class="ai ai-orcid-square ai-fw"></i> ORCID</a></li></ul></div></div></div><article class="page" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="headline" content="Three things I love about CircleCI"><meta itemprop="datePublished" content="January 29, 2019"><div class="page__inner-wrap"><header><h1 class="page__title" itemprop="headline">Three things I love about CircleCI</h1><p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Published:</strong> <time datetime="2019-01-29T00:00:00+00:00">January 29, 2019</time></p></header><section class="page__content" itemprop="text"><p>I recently had to beef up the continuous deployment of Jupyter Book, and used it as an opportunity to learn a bit more about CircleCI’s features. It turns out, they’re pretty cool! Here are a few of the things that I learned this time around.</p><p>For those who aren’t familiar with CircleCI, it is a service that runs Continuous Integration and Continuous Deployment (CI/CD) workflows for projects. This basically means that they manage many kinds of infrastructure that can launch jobs that run test suites, deploy applications, and test on many different environments.</p><p>Here are some cool things that I now have a much better appreciation for:</p><h2 id="re-run-a-job-with-ssh-access">Re-run a job with SSH access</h2><p>Often when tests don’t pass or a build otherwise fails, it’s really helpful to be able to get into the machine itself and just start poking around. It turns out that CircleCI makes this really easy! If a build has failed, then you can use the drop-down menu next to the “Restart Job” button to select “Restart Job with SSH”. The next time the job fails (which it probably will, since you’ve just restarted a job that already failed once), CircleCI will print the IP address and SSH command to connect to that machine remotely.</p><h2 id="persisting-files-between-jobs-with-workspaces">Persisting files between jobs with Workspaces</h2><p>Everything CircleCI does is based around containers - each job has a Docker image environment specified (and CircleCI curates a large list of containers for testing). One challenge this introduces is that it can be more complex to use jobs that have <em>multiple</em> languages or tools installed. You can always manually configure this, but I’ve found that another easy solution is to split your task across multiple jobs, and persist some of the files between them with CircleCI workspaces.</p><p>To set up a CircleCI workspace, you first need two jobs, then</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build_files</span><span class="pi">:</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="c1"># We use a Python image to test our files and run the test suite</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/python:3.6-stretch</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Some steps to build files we need in another job</span>
      <span class="c1"># Assume it places the built files into a folder called `_build/`</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">build_stuff_with_python</span>

      <span class="c1"># Persist the specified paths (see https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs)</span>
      <span class="pi">-</span> <span class="na">persist_to_workspace</span><span class="pi">:</span>
          <span class="c1"># The root of the workspace, here just the CWD</span>
          <span class="na">root</span><span class="pi">:</span> <span class="s">.</span>
          <span class="c1"># The sub-paths of the workspace to persist</span>
          <span class="na">paths</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">_build/</span>

  <span class="na">deploy_files</span><span class="pi">:</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="c1"># We'll use a Ruby image to deploy our files</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/ruby:2.6</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Connect the files from the last job to this job</span>
      <span class="pi">-</span> <span class="na">attach_workspace</span><span class="pi">:</span>
          <span class="c1"># Must be absolute path or relative path from working_directory</span>
          <span class="na">at</span><span class="pi">:</span> <span class="s">/tmp/workspace</span>

      <span class="c1"># Our final deployment steps</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">deploy_files_with_ruby</span>
</code></pre></div></div><p>Finally, we’ll set up a CircleCI workflow that runs the deployment job only after the build job as finished, since the deploy job depends on files that are created by the build job.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">workflows</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">build_files</span>
      <span class="c1">#</span>
      <span class="pi">-</span> <span class="na">deploy_files</span><span class="pi">:</span>
          <span class="na">requires</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">build_files</span>
</code></pre></div></div><p>In this way, we’ve split our task (build a bunch of files, then deploy them online) into two different jobs. One that builds files with a Python container, and another that deploys them with a Ruby container.</p><h2 id="re-use-code-snippets-with-commands">Re-use code snippets with Commands</h2><p>Finally, many times you’d like to re-use the same set of snippets across multiple points of your CircleCI jobs. In 2.1, CircleCI added a new feature called Commands that does this fairly simply. Commands are kind of like functions in that they wrap up a collection of steps that can be re-used and parameterized. This means you can define a “template” of a collection of steps, then fill-in missing fields in that template in order to modify its behavior.</p><p>For example, here’s a Command template to build a site with Jekyll:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">commands</span><span class="pi">:</span>
  <span class="na">build_site</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Build</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Jekyll"</span>
    <span class="na">parameters</span><span class="pi">:</span>
      <span class="c1"># We'll define one parameter that lets us pass build arguments to Jekyll build</span>
      <span class="na">build_args</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Build the website</span>
          <span class="c1"># Note the &lt;&lt; parameters.param &gt;&gt; syntax that lets you define your own inputs</span>
          <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec jekyll build &lt;&lt; parameters.build_args &gt;&gt;</span>
</code></pre></div></div><p>Now, we can re-use this command throughout our build steps. Here are two jobs that use this command in different ways:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># Build the site to store artifacts</span>
  <span class="na">build_with_params</span><span class="pi">:</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Build the site's HTML w/ the base_url for CircleCI artifacts</span>
      <span class="pi">-</span> <span class="na">build_site</span><span class="pi">:</span>
          <span class="na">build_args</span><span class="pi">:</span> <span class="s">--baseurl /0/html/</span>
  <span class="c1"># Build the site to store artifacts</span>
  <span class="na">build_without_params</span><span class="pi">:</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># Build the site's HTML w/ defaults for Jekyll</span>
      <span class="pi">-</span> <span class="na">build_site</span><span class="pi">:</span>
          <span class="na">build_args</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre></div></div><p>Each of these jobs uses the command specified above in <code class="language-plaintext highlighter-rouge">build_site</code>, but they use the <code class="language-plaintext highlighter-rouge">build_args</code> parameter to modify its behavior each time.</p></section><footer class="page__meta"><p class="page__taxonomy"> <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="https://predictablynoisy.com/tags/#cd" class="page__taxonomy-item" rel="tag">CD</a><span class="sep">, </span> <a href="https://predictablynoisy.com/tags/#ci" class="page__taxonomy-item" rel="tag">CI</a><span class="sep">, </span> <a href="https://predictablynoisy.com/tags/#continuous-integration" class="page__taxonomy-item" rel="tag">continuous integration</a><span class="sep">, </span> <a href="https://predictablynoisy.com/tags/#dev-ops" class="page__taxonomy-item" rel="tag">dev ops</a><span class="sep">, </span> <a href="https://predictablynoisy.com/tags/#software-development" class="page__taxonomy-item" rel="tag">software development</a> </span></p></footer></div></article></div></script><div class="page__footer"><footer> <!-- start custom footer snippets --> <a href="/sitemap/">Sitemap</a> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons"><li><strong>Follow:</strong></li><li><a href="https://twitter.com/choldgraf"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li><li><a href="http://github.com/choldgraf"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li><li><a href="https://predictablynoisy.com/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li></ul></div><div class="page__footer-copyright">&copy; 2020 Chris Holdgraf. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="https://predictablynoisy.com/assets/js/main.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-88310237-1', 'auto'); ga('send', 'pageview'); </script></body></html>
